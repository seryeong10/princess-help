<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>ÏÑ∏Î†πÍ≥µÏ£º Íµ¨Ï∂ú</title>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden}
.game{position:fixed;inset:0}
.img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.hs{position:absolute;border:0;background:transparent;-webkit-tap-highlight-color:transparent}
.hs:active{transform:scale(.96)}

#boom{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;pointer-events:none}

#stream{
 position:absolute;
 left:50%;
 top:22%;
 width:32%;
 transform:translateX(-50%) translateY(-60px);
 opacity:0;
 pointer-events:none;
}
@keyframes drop{
 0%{opacity:0;transform:translateX(-50%) translateY(-60px)}
 10%{opacity:1}
 100%{opacity:0;transform:translateX(-50%) translateY(420px)}
}

/* UI */
.uiBar{position:absolute;left:0;right:0;bottom:20px;display:none;justify-content:center;gap:12px;z-index:9999}
.uiBtn{
 border:0;border-radius:50%;
 width:64px;height:64px;
 font-size:28px;font-weight:900;
 background:rgba(255,255,255,.92);
 color:#000;
 box-shadow:0 6px 20px rgba(0,0,0,.55);
}
.uiBtn:active{transform:scale(.97)}

.uiNext{
 position:absolute;right:16px;bottom:100px;
 border:0;border-radius:14px;
 padding:12px 16px;
 font-weight:900;font-size:16px;
 background:#ff4d6d;color:#fff;
 display:none; z-index:9999;
}
.uiNext.show{display:block}

.hintText{
 position:absolute;top:14px;left:0;right:0;
 text-align:center;color:#fff;font-weight:800;
 text-shadow:0 2px 10px rgba(0,0,0,.8);
 padding:0 14px;z-index:9999;pointer-events:none;
}

/* ===== ÏûêÎ¨ºÏá† Ïà´Ïûê Î≤ÑÌäº ===== */
:root{
  --lock-x: 22%;
  --lock-y: 50%;
  --lock-w: 56%;
  --lock-h: 9%;
}
.lockDigits{
 position:absolute;
 left:var(--lock-x);
 top:var(--lock-y);
 width:var(--lock-w);
 height:var(--lock-h);
 display:grid;
 grid-template-columns:repeat(4,1fr);
 gap:4%;
 z-index:9999;
 pointer-events:auto;
}
.digitBtn{
 border:0;
 border-radius:14px;
 background:rgba(0,0,0,.45);
 color:#fff;
 font-weight:900;
 font-size:clamp(18px, 6vw, 34px);
 box-shadow: inset 0 0 0 1px rgba(255,255,255,.14), 0 8px 18px rgba(0,0,0,.35);
 -webkit-tap-highlight-color:transparent;
}
.digitBtn:active{ transform:scale(.97); }
.digitBtn:disabled{ opacity:.95; }

/* Ï†ïÎãµ/Ïò§Îãµ Ìö®Í≥º */
.lockSuccess{ animation: glowGreen 0.6s ease; }
@keyframes glowGreen{
 0%{ box-shadow:0 0 0px #00ff88; }
 50%{ box-shadow:0 0 25px #00ff88; }
 100%{ box-shadow:0 0 0px #00ff88; }
}
.lockFail{ animation: glowRed 0.4s ease; }
@keyframes glowRed{
 0%{ box-shadow:0 0 0px #ff0000; }
 50%{ box-shadow:0 0 25px #ff0000; }
 100%{ box-shadow:0 0 0px #ff0000; }
}
.shake{ animation: shakeLock .35s ease; }
@keyframes shakeLock{
 0%{transform:translateX(0)}
 25%{transform:translateX(-6px)}
 50%{transform:translateX(6px)}
 75%{transform:translateX(-4px)}
 100%{transform:translateX(0)}
}
</style>
</head>
<body>

<div class="game" id="game">
  <img id="scene" class="img" alt="scene">
  <img id="stream" alt="stream">
  <img id="boom" src="boom.png" alt="boom">

  <div class="hintText" id="hint"></div>

  <div class="uiBar" id="wallUI">
    <button class="uiBtn" id="btnL">‚óÄ</button>
    <button class="uiBtn" id="btnC">‚ñ≤</button>
    <button class="uiBtn" id="btnR">‚ñ∂</button>
  </div>
  <button class="uiNext" id="btnNext">Îã§Ïùå ‚ñ∂</button>
</div>

<!-- ÏÇ¨Ïö¥Îìú -->
<audio id="bgm" src="bgm.mp3" loop></audio>
<audio id="endbgm" src="end.mp3" loop></audio>
<audio id="tap" src="tap.mp3"></audio>
<audio id="unlock" src="unlock.mp3"></audio>
<audio id="mix" src="mix.mp3"></audio>
<audio id="pour" src="pour.mp3"></audio>
<audio id="paper" src="paper.mp3"></audio>
<audio id="get" src="get.mp3"></audio>
<audio id="stage" src="stage.mp3"></audio>
<audio id="drawer" src="drawer.mp3"></audio>
<audio id="boomS" src="boom.mp3"></audio>

<script>
const scene=document.getElementById("scene");
const game=document.getElementById("game");
const stream=document.getElementById("stream");
const boom=document.getElementById("boom");
const hint=document.getElementById("hint");

const wallUI=document.getElementById("wallUI");
const btnL=document.getElementById("btnL");
const btnC=document.getElementById("btnC");
const btnR=document.getElementById("btnR");
const btnNext=document.getElementById("btnNext");

const bgm=document.getElementById("bgm");
const endbgm=document.getElementById("endbgm");
const tap=document.getElementById("tap");
const unlock=document.getElementById("unlock");
const mix=document.getElementById("mix");
const pour=document.getElementById("pour");
const paper=document.getElementById("paper");
const get=document.getElementById("get");
const stage=document.getElementById("stage");
const drawer=document.getElementById("drawer");
const boomS=document.getElementById("boomS");

function s(a){ try{a.currentTime=0;a.play();}catch{} }

function clearOverlays(){
  document.querySelectorAll(".lockDigits").forEach(el=>el.remove());
  document.querySelectorAll(".hsFull").forEach(el=>el.remove());
  document.querySelectorAll(".hs").forEach(el=>{ if(!el.classList.contains("hsFull")) el.remove(); });
  document.querySelectorAll(".uiNextTemp").forEach(el=>el.remove());
}

function setScene(src){
  scene.src=src;
  hint.textContent="";
  wallUI.style.display="none";
  btnNext.classList.remove("show");
  clearOverlays();
}

function fullTap(nextFn){
  const b=document.createElement("button");
  b.className="hs hsFull";
  b.style.left="0"; b.style.top="0"; b.style.width="100%"; b.style.height="100%";
  b.onclick=()=>{ b.remove(); nextFn(); };
  game.appendChild(b);
}

function addHS(x,y,w,h,fn){
  const b=document.createElement("button");
  b.className="hs";
  b.style.left=x+"%"; b.style.top=y+"%";
  b.style.width=w+"%"; b.style.height=h+"%";
  b.onclick=fn;
  game.appendChild(b);
}

function makeBottomNext(label, onClick){
  const b=document.createElement("button");
  b.className="uiNext show uiNextTemp";
  b.textContent=label;
  b.onclick=onClick;
  game.appendChild(b);
}

/* ===== ÏûêÎ¨ºÏá†(ÌÑ∞ÏπòÌï¥ÏÑú Îã§ÏùåÏúºÎ°ú) ===== */
function lockStageWithTapToNext(answer, closedImg, openImg, nextFn){
  setScene(closedImg);
  hint.textContent="Ïà´ÏûêÎ•º ÎàåÎü¨ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÎßûÏ∂∞Îùº";

  const wrap=document.createElement("div");
  wrap.className="lockDigits";

  const code=[0,0,0,0];
  const btns=[];

  function flash(cls, ms){
    btns.forEach(b=>{
      b.classList.add(cls);
      setTimeout(()=>b.classList.remove(cls), ms);
    });
  }

  function onSuccess(){
    btns.forEach(b=> b.disabled = true);
    flash("lockSuccess", 600);
    scene.classList.add("shake");
    s(unlock);

    setTimeout(()=>{
      scene.classList.remove("shake");
      scene.src = openImg;
      s(stage);
      hint.textContent = "ÏÑ±Í≥µ! ÌôîÎ©¥ÏùÑ ÌÑ∞ÏπòÌï¥ Îã§Ïùå Îã®Í≥ÑÎ°ú";
      fullTap(()=>{ s(tap); nextFn(); });
    }, 500);
  }

  function onFail(){
    flash("lockFail", 350);
    scene.classList.add("shake");
    setTimeout(()=>scene.classList.remove("shake"),200);
  }

  for(let i=0;i<4;i++){
    const b=document.createElement("button");
    b.className="digitBtn";
    b.textContent="0";

    b.addEventListener("pointerdown",(e)=>{
      e.preventDefault();
      if(b.disabled) return;

      s(tap);
      code[i]=(code[i]+1)%10;
      b.textContent=String(code[i]);

      if(code.join("")===answer) onSuccess();
      else onFail();
    }, {passive:false});

    wrap.appendChild(b);
    btns.push(b);
  }

  game.appendChild(wrap);
}

/* ===== ÏãúÏûë ===== */
function S0(){
  setScene("s0.png");
  fullTap(()=>{
    s(tap);
    bgm.volume=.35;
    bgm.play().catch(()=>{});
    S1();
  });
}
function S1(){
  setScene("s1.png");
  fullTap(()=>{ s(tap); F0(); });
}

/* ===== ÏÜêÏ†ÑÎì± ===== */
function F0(){
  setScene("f0.png");
  hint.textContent="Ï±ÖÏÉÅÏùÑ ÎàåÎü¨Îùº";
  fullTap(()=>{ s(drawer); F1(); });
}
function F1(){
  setScene("k2c.png");
  hint.textContent="ÏÑúÎûçÏùÑ ÌôïÏù∏Ìï¥Îùº";
  fullTap(()=>{ s(get); F2(); });
}
function F2(){
  setScene("flash.png");
  hint.textContent="ÏÜêÏ†ÑÎì± ÌöçÎìù!";
  setTimeout(()=>WallStart(),1000);
}

/* ===== Î≤Ω ===== */
let sawHintWall=false;
function WallStart(){
  sawHintWall=false;
  showWall("c");
}
function showWall(where){
  if(where==="l"){ setScene("fl.png"); sawHintWall=true; }
  if(where==="c"){ setScene("fc.png"); }
  if(where==="r"){ setScene("fr.png"); }

  wallUI.style.display="flex";
  btnL.style.display="inline-block";
  btnC.style.display="inline-block";
  btnR.style.display="inline-block";

  hint.textContent = sawHintWall ? "ÌûåÌä∏Î•º Ï∞æÏïòÎã§!" : "Ïñ¥ÎîîÏóê ÌûåÌä∏Í∞Ä ÏûàÏùÑÍπå‚Ä¶?";

  btnL.onclick=()=>{ s(tap); showWall("l"); };
  btnC.onclick=()=>{ s(tap); showWall("c"); };
  btnR.onclick=()=>{ s(tap); showWall("r"); };

  if(sawHintWall) btnNext.classList.add("show");
  else btnNext.classList.remove("show");

  btnNext.onclick=()=>{
    if(!sawHintWall) return;
    s(unlock);
    Lock1();
  };
}

/* ===== 1Îã®Í≥Ñ ÏûêÎ¨ºÏá†(1019) ÏÑ±Í≥µ ÌõÑ ÌÑ∞ÏπòÌïòÎ©¥ Î¨ºÏïΩÎ∞© ===== */
function Lock1(){
  lockStageWithTapToNext("1019","k1c.png","k1o.png",Potion);
}

/* ===== 2Îã®Í≥Ñ: Î¨ºÏïΩÎ∞© ===== */
const colorMap={
  blue:"q1.png", brown:"q2.png", black:"q3.png",
  purple:"q4.png", skin:"q5.png", red:"q6.png",
  pink:"q7.png", lime:"q8.png", yellow:"q9.png"
};

function Potion(){
  let selected = new Set();
  let solved = false;

  showP0();

  function resetToP0(){
    selected = new Set();
    solved = false;
    showP0();
  }

  function showP0(){
    setScene("p0.png");
    hint.textContent = "Î¨ºÏïΩÏùÑ 3Í∞ú ÏÑûÏñ¥ ÌûåÌä∏Î•º Ï∞æÏïÑÎùº";

    // üìö ÏÑ§Î™ÖÏÑú(ÏôºÏ™Ω ÌïòÎã® Ï±Ö)
    addHS(6, 74, 18, 18, ()=>{
      s(paper);
      showManual();
    });

    // ‚úÖ Î≥ë Ï¢åÌëú(ÎÑ§ Ïù¥ÎØ∏ÏßÄ Í∏∞Ï§Ä)
    // ÏÉÅÎã®
    addBottle(12, 28, "black");   // Í≤ÄÏ†ï
    addBottle(20, 35, "pink");    // ÌïëÌÅ¨(ÏÉÅÎã® ÏôºÏ™Ω)
    addBottle(42, 30, "brown");   // Í∞àÏÉâ
    addBottle(55, 28, "purple");  // Î≥¥Îùº
    addBottle(66, 35, "skin");    // ÏÇ¥ÏÉâ(ÏÉÅÎã® Ïò§Î•∏Ï™Ω Ìù∞Î≥ë)

    // ÏÉÅÎã® Ï§ëÎ≥µ Ï∂îÍ∞Ä(ÏöîÏ≤≠)
    addBottle(68, 30, "skin");    // 6Î≤àÏß∏ ÏÇ¥ÏÉâ Ï§ëÎ≥µ
    addBottle(76, 30, "yellow");  // 7Î≤àÏß∏ ÎÖ∏Îûë Ï§ëÎ≥µ
    addBottle(86, 30, "red");     // 8Î≤àÏß∏ Îπ®Í∞ï Ï§ëÎ≥µ

    // ÌïòÎã®
    addBottle(8, 63, "red");      // Îπ®Í∞ï(ÌïòÎã® ÏôºÏ™Ω)
    addBottle(20, 67, "lime");    // Ïó∞Îëê
    addBottle(33, 63, "blue");    // ÌååÎûë(Ï†ïÎãµ)
    addBottle(48, 63, "yellow");  // ÎÖ∏Îûë(ÌïòÎã®)
    // (ÎÇòÎ®∏ÏßÄ ÏÉâ ÌïÑÏöîÌïòÎ©¥ Îçî Ï∂îÍ∞Ä Í∞ÄÎä•)

    // ÏÑ±Í≥µÌïòÎ©¥ ‚ÄúÎã§Ïùå‚Äù Î≤ÑÌäº ÏÉùÏÑ±
    if(solved){
      makeBottomNext("Îã§Ïùå ‚ñ∂", ()=>{
        s(tap);
        showPaper0();
      });
    }
  }

  function showManual(){
    setScene("m0.png");
    hint.textContent = "ÌôîÎ©¥ÏùÑ ÌÑ∞ÏπòÌïòÎ©¥ Îã´Ìûò";
    fullTap(()=>{ s(tap); showP0(); });
  }

  function addBottle(x,y,key){
    addHS(x, y, 12, 16, ()=>{
      if(solved) return;
      s(mix);

      // Í∞ôÏùÄ ÏÉâ Ïó¨Îü¨Î≤à ÎàåÎü¨ÎèÑ SetÏù¥Îùº Ï§ëÎ≥µ Ïπ¥Ïö¥Ìä∏ ÏïàÎê®
      selected.add(key);

      // Î¨ºÏ§ÑÍ∏∞ Ïï†ÎãàÎ©îÏù¥ÏÖò
      stream.src = colorMap[key];
      stream.style.animation="none"; void stream.offsetWidth;
      stream.style.animation="drop 600ms ease forwards";

      checkMix();
    });
  }

  function checkMix(){
    const ok = (selected.size===3 &&
      selected.has("blue") &&
      selected.has("brown") &&
      selected.has("black"));

    if(selected.size>=3 && !ok){
      bomb();
      return;
    }

    if(ok){
      solved = true;
      s(stage);
      hint.textContent = "Ï†ïÎãµÏù¥Îã§! Ï¢ÖÏù¥Î•º ÌôïÏù∏ÌïòÏûê";
      showP0();
    }
  }

  function bomb(){
    s(boomS);
    setScene("boom.png");
    hint.textContent = "Îª•! Îã§Ïãú Ìï¥!";
    setTimeout(()=>resetToP0(), 1000);
  }

  function showPaper0(){
    setScene("pp0.png");
    hint.textContent = "ÌôîÎ©¥ÏùÑ ÌÑ∞ÏπòÌï¥ Ï¢ÖÏù¥Î•º ÌéºÏ≥êÎùº";
    fullTap(()=>{ s(paper); showPaper1(); });
  }

  function showPaper1(){
    setScene("pp1.png");
    hint.textContent = "0506‚Ä¶";
    makeBottomNext("Îã§Ïùå ‚ñ∂", ()=>{
      s(tap);
      Lock2();
    });
  }

  function Lock2(){
    lockStageWithTapToNext("0506","k1c.png","k1o.png",Books);
  }
}

/* ===== 3Îã®Í≥Ñ Ï±ÖÏû• ===== */
function Books(){
  setScene("b0.png");
  hint.textContent="ÏÑ∏Î†πÍ≥µÏ£ºÏóêÍ≤å Ï§Ä Ï±ÖÏùÑ Ï∞æÏïÑÎùº";

  addHS(10,60,30,10,()=>{ s(tap); hint.textContent="Îï°!"; setTimeout(()=>hint.textContent="ÏÑ∏Î†πÍ≥µÏ£ºÏóêÍ≤å Ï§Ä Ï±ÖÏùÑ Ï∞æÏïÑÎùº",700); });
  addHS(10,72,30,10,()=>{ s(tap); hint.textContent="Îï°!"; setTimeout(()=>hint.textContent="ÏÑ∏Î†πÍ≥µÏ£ºÏóêÍ≤å Ï§Ä Ï±ÖÏùÑ Ï∞æÏïÑÎùº",700); });

  addHS(10,84,30,10,()=>{
    s(get);
    setScene("key.png");
    hint.textContent="Ïó¥Ïá† ÌöçÎìù!";
    fullTap(()=>Lock3());
  });
}

/* ÎßàÏßÄÎßâ ÏûêÎ¨ºÏá† */
function Lock3(){
  setScene("k3c.png");
  hint.textContent="ÌôîÎ©¥ÏùÑ ÌÑ∞ÏπòÌï¥ ÏûêÎ¨ºÏá†Î•º Ïó¥Ïñ¥Îùº";
  fullTap(()=>{
    s(unlock);
    setScene("k3o.png");
    setTimeout(()=>End(),900);
  });
}

function End(){
  bgm.pause(); bgm.currentTime=0;
  endbgm.volume=0.5;
  endbgm.play().catch(()=>{});
  setScene("end.png");
}

S0();
</script>
</body>
</html>
