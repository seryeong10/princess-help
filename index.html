<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>세령공주 구출</title>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden}
.game{position:fixed;inset:0}
.img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

/* 클릭영역(투명버튼) */
.hs{position:absolute;border:0;background:transparent;-webkit-tap-highlight-color:transparent}
.hs:active{transform:scale(.96)}
.hsFull{position:absolute;left:0;top:0;width:100%;height:100%}

/* 상단 안내 */
.hintText{
 position:absolute;top:14px;left:0;right:0;
 text-align:center;color:#fff;font-weight:800;
 text-shadow:0 2px 10px rgba(0,0,0,.85);
 padding:0 14px;z-index:9999;pointer-events:none;
}

/* ===== 벽 이동 화살표 UI ===== */
.uiBar{position:absolute;left:0;right:0;bottom:20px;display:none;justify-content:center;gap:12px;z-index:9999}
.uiBtn{
 border:0;border-radius:50%;
 width:64px;height:64px;
 font-size:28px;font-weight:900;
 background:rgba(255,255,255,.92);
 color:#000;
 box-shadow:0 6px 20px rgba(0,0,0,.55);
}
.uiBtn:active{transform:scale(.97)}
.uiNext{
 position:absolute;right:16px;bottom:100px;
 border:0;border-radius:14px;
 padding:12px 16px;
 font-weight:900;font-size:16px;
 background:#ff4d6d;color:#fff;
 display:none; z-index:9999;
}
.uiNext.show{display:block}

/* ===== 공통 버튼 ===== */
.bigBtn{
 position:absolute;left:50%;bottom:26px;transform:translateX(-50%);
 border:0;border-radius:16px;
 padding:14px 18px;
 font-weight:900;font-size:18px;
 background:rgba(255,255,255,.92);
 color:#111;
 box-shadow:0 10px 25px rgba(0,0,0,.55);
 z-index:9999;
}
.bigBtn:active{transform:translateX(-50%) scale(.98)}

/* ===== 자물쇠 숫자 버튼 ===== */
:root{
  /* 자물쇠 숫자 오버레이 위치(필요하면 여기만 살짝 조정) */
  --lock-x: 22%;
  --lock-y: 50%;
  --lock-w: 56%;
  --lock-h: 9%;
}
.lockDigits{
 position:absolute;
 left:var(--lock-x);
 top:var(--lock-y);
 width:var(--lock-w);
 height:var(--lock-h);
 display:grid;
 grid-template-columns:repeat(4,1fr);
 gap:4%;
 z-index:9999;
 pointer-events:auto;
}
.digitBtn{
 border:0;
 border-radius:14px;
 background:rgba(0,0,0,.45);
 color:#fff;
 font-weight:900;
 font-size:clamp(18px, 6vw, 34px);
 box-shadow: inset 0 0 0 1px rgba(255,255,255,.14), 0 8px 18px rgba(0,0,0,.35);
 -webkit-tap-highlight-color:transparent;
}
.digitBtn:active{ transform:scale(.97); }
.lockSuccess{ animation: glowGreen 0.6s ease; }
@keyframes glowGreen{
 0%{ box-shadow:0 0 0px #00ff88; }
 50%{ box-shadow:0 0 25px #00ff88; }
 100%{ box-shadow:0 0 0px #00ff88; }
}
.lockFail{ animation: glowRed 0.4s ease; }
@keyframes glowRed{
 0%{ box-shadow:0 0 0px #ff0000; }
 50%{ box-shadow:0 0 25px #ff0000; }
 100%{ box-shadow:0 0 0px #ff0000; }
}
.shake{ animation: shakeLock .35s ease; }
@keyframes shakeLock{
 0%{transform:translateX(0)}
 25%{transform:translateX(-6px)}
 50%{transform:translateX(6px)}
 75%{transform:translateX(-4px)}
 100%{transform:translateX(0)}
}

/* ===== 2단계 물약: 병 이미지 배치 ===== */
.layer{position:absolute;inset:0;z-index:10;pointer-events:none}
.potionJar{
 position:absolute;
 width:18%;
 z-index:30;
 pointer-events:auto;
 user-select:none;
 -webkit-user-drag:none;
}
.potionJar:active{transform:scale(.97)}
/* 병 위치(필요하면 여기만 살짝 조정) */
#jar_blue  {left:14%; bottom:15%; width:18%;}
#jar_black {left:32%; bottom:15%; width:18%;}
#jar_brown {left:50%; bottom:15%; width:18%;}
#jar_red   {left:68%; bottom:15%; width:18%;}
#jar_yellow{left:14%; bottom:33%; width:18%;}
#jar_pink  {left:68%; bottom:33%; width:18%;}

/* 솥 물색 오버레이(간단 색변경 효과) */
.cauldronTint{
 position:absolute;
 left:28%;
 top:46%;
 width:44%;
 height:20%;
 border-radius:999px;
 background:rgba(0,0,0,0);
 filter:blur(2px);
 z-index:20;
 pointer-events:none;
 transition:background .25s ease, box-shadow .35s ease;
}
.cauldronGlow{
 box-shadow:0 0 25px rgba(0,255,120,.7), 0 0 55px rgba(0,255,120,.45);
}

/* 매뉴얼 팝업 */
.popup{
 position:absolute; left:50%; top:18%;
 transform:translateX(-50%);
 width:78%;
 z-index:60;
 display:none;
 pointer-events:auto;
}
.popup.show{display:block}

/* 종이 화면 */
.paper{
 position:absolute; left:50%; top:18%;
 transform:translateX(-50%);
 width:82%;
 z-index:60;
 display:none;
 pointer-events:auto;
}
.paper.show{display:block}

/* 3단계 책장 + 책들 */
.bookWrap{
 position:absolute; inset:0; z-index:20;
}
.book{
 position:absolute;
 width:26%;
 z-index:30;
 pointer-events:auto;
 user-select:none;
 -webkit-user-drag:none;
}
.book:active{transform:scale(.97)}
/* 책 위치(필요하면 여기만 조정) */
#book1{left:37%; top:22%; width:30%;}
#book2{left:37%; top:40%; width:30%;}
#book3{left:37%; top:58%; width:30%;}
#book4{left:37%; top:76%; width:30%;}
</style>
</head>
<body>

<div class="game" id="game">
  <img id="scene" class="img" alt="scene">
  <div class="hintText" id="hint"></div>

  <!-- 벽 이동 UI -->
  <div class="uiBar" id="wallUI">
    <button class="uiBtn" id="btnL">◀</button>
    <button class="uiBtn" id="btnC">▲</button>
    <button class="uiBtn" id="btnR">▶</button>
  </div>
  <button class="uiNext" id="btnNext">다음 ▶</button>
</div>

<!-- 사운드 -->
<audio id="bgm" src="bgm.mp3" loop></audio>
<audio id="endbgm" src="end.mp3" loop></audio>
<audio id="tap" src="tap.mp3"></audio>
<audio id="unlock" src="unlock.mp3"></audio>
<audio id="mix" src="mix.mp3"></audio>
<audio id="pour" src="pour.mp3"></audio>
<audio id="paper" src="paper.mp3"></audio>
<audio id="get" src="get.mp3"></audio>
<audio id="stage" src="stage.mp3"></audio>
<audio id="drawer" src="drawer.mp3"></audio>
<audio id="boomS" src="boom.mp3"></audio>

<script>
/* =========================
   ✅ 파일명 설정 (여기만 네 파일명에 맞게)
========================= */
const ASSET = {
  // 시작/스토리
  s0: "s0.png",
  s1: "s1.png",

  // 1단계(손전등/벽)
  f0: "f0.png",
  drawerOpen: "k2c.png",
  flashGet: "flash.png",
  wallL: "fl.png",
  wallC: "fc.png",
  wallR: "fr.png",
  lock1Closed: "k1c.png",
  lock1Open: "k1o.png",

  // 2단계(물약)
  potionBg: "bg_potion_room.png",
  jar_pink: "jar_pink.png",
  jar_yellow: "jar_yellow.png",
  jar_red: "jar_red.png",
  jar_brown: "jar_brown.png",
  jar_black: "jar_black.png",
  jar_blue: "jar_blue.png",
  manualPopup: "manual_popup.png",
  paperClean: "paper_clean.png",
  paperRevealed: "paper_revealed.png",

  // 3단계(책장)
  bookBg: "b0.png",
  keyScene: "key.png",

  // ⚠️ 책 4권 파일명 (네가 만든 실제 파일명으로 맞춰줘)
  book1: "book_oldsea.png",      // 노인과 바다
  book2: "book_yourchoice.png",  // 너의 결정
  book3: "book_rapids.png",      // 급류
  book4: "book_selfchoice.png",  // 자기 결정(정답)

  // 3단계 자물쇠
  lock3Closed: "k3c.png",
  lock3Open: "k3o.png",

  // 엔딩/편지
  ending: "end.png",
  letter: "letter.png"
};

// 2단계 정답 조합(파랑/갈색/검정)
const POTION_ANSWER = new Set(["blue","brown","black"]);

// 2단계 자물쇠 비번
const LOCK2_ANSWER = "0506";
// 1단계 자물쇠 비번
const LOCK1_ANSWER = "1019";

/* =========================
   기본 DOM/사운드
========================= */
const scene=document.getElementById("scene");
const game=document.getElementById("game");
const hint=document.getElementById("hint");

const wallUI=document.getElementById("wallUI");
const btnL=document.getElementById("btnL");
const btnC=document.getElementById("btnC");
const btnR=document.getElementById("btnR");
const btnNext=document.getElementById("btnNext");

const bgm=document.getElementById("bgm");
const endbgm=document.getElementById("endbgm");
const tap=document.getElementById("tap");
const unlock=document.getElementById("unlock");
const mix=document.getElementById("mix");
const pour=document.getElementById("pour");
const paper=document.getElementById("paper");
const get=document.getElementById("get");
const stage=document.getElementById("stage");
const drawer=document.getElementById("drawer");
const boomS=document.getElementById("boomS");

function s(a){ try{a.currentTime=0;a.play();}catch{} }

/* =========================
   오버레이 관리
========================= */
function clearOverlays(){
  // full tap
  document.querySelectorAll(".hsFull").forEach(el=>el.remove());
  // lock digits
  document.querySelectorAll(".lockDigits").forEach(el=>el.remove());
  // big buttons
  document.querySelectorAll(".bigBtn").forEach(el=>el.remove());
  // potion layers
  document.querySelectorAll(".layer").forEach(el=>el.remove());
  document.querySelectorAll(".popup").forEach(el=>el.remove());
  document.querySelectorAll(".paper").forEach(el=>el.remove());
  document.querySelectorAll(".cauldronTint").forEach(el=>el.remove());
  // book wrap
  document.querySelectorAll(".bookWrap").forEach(el=>el.remove());
}

function setScene(src){
  scene.src=src;
  hint.textContent="";
  wallUI.style.display="none";
  btnNext.classList.remove("show");
  clearOverlays();
}

function fullTap(nextFn){
  const b=document.createElement("button");
  b.className="hs hsFull";
  b.onclick=()=>{ b.remove(); nextFn(); };
  game.appendChild(b);
}

function makeBtn(text, onClick, opt={}){
  const b=document.createElement("button");
  b.className="bigBtn";
  b.textContent=text;
  if(opt.bottom != null) b.style.bottom = opt.bottom + "px";
  if(opt.left != null) { b.style.left = opt.left; b.style.transform = "translateX(0)"; }
  b.onclick=onClick;
  game.appendChild(b);
  return b;
}

/* =========================
   0) 시작/스토리
========================= */
function S0(){
  setScene(ASSET.s0);
  fullTap(()=>{
    s(tap);
    bgm.volume=.35;
    bgm.play().catch(()=>{});
    S1();
  });
}
function S1(){
  setScene(ASSET.s1);
  fullTap(()=>{ s(tap); F0(); });
}

/* =========================
   1) 손전등 단계
========================= */
function F0(){
  setScene(ASSET.f0);
  hint.textContent="책상을 눌러라";
  fullTap(()=>{ s(drawer); F1(); });
}
function F1(){
  setScene(ASSET.drawerOpen);
  hint.textContent="서랍을 확인해라";
  fullTap(()=>{ s(get); F2(); });
}
function F2(){
  setScene(ASSET.flashGet);
  hint.textContent="손전등 획득!";
  setTimeout(()=>WallStart(), 900);
}

/* 벽: 정면부터 + 화살표 3개 항상 보임, 왼쪽(fl) 한 번 보면 다음 버튼 */
let sawHintWall=false;
function WallStart(){
  sawHintWall=false;
  showWall("c");
}
function showWall(where){
  if(where==="l"){ setScene(ASSET.wallL); sawHintWall=true; }
  if(where==="c"){ setScene(ASSET.wallC); }
  if(where==="r"){ setScene(ASSET.wallR); }

  wallUI.style.display="flex";
  btnL.style.display="inline-block";
  btnC.style.display="inline-block";
  btnR.style.display="inline-block";

  hint.textContent = sawHintWall ? "힌트를 찾았다!" : "어디에 힌트가 있을까…?";

  btnL.onclick=()=>{ s(tap); showWall("l"); };
  btnC.onclick=()=>{ s(tap); showWall("c"); };
  btnR.onclick=()=>{ s(tap); showWall("r"); };

  if(sawHintWall) btnNext.classList.add("show");
  else btnNext.classList.remove("show");

  btnNext.onclick=()=>{
    if(!sawHintWall) return;
    s(tap);
    Lock1();
  };
}

/* =========================
   자물쇠(숫자 클릭형) - 성공 시 열린사진으로 바꾸고 "터치해서 다음"
========================= */
function lockStage(answer, closedImg, openImg, nextFn){
  setScene(closedImg);
  hint.textContent="숫자를 눌러 비밀번호를 맞춰라";

  const wrap=document.createElement("div");
  wrap.className="lockDigits";

  const code=[0,0,0,0];
  const btns=[];

  function flash(cls, ms){
    btns.forEach(b=>{
      b.classList.add(cls);
      setTimeout(()=>b.classList.remove(cls), ms);
    });
  }

  for(let i=0;i<4;i++){
    const b=document.createElement("button");
    b.className="digitBtn";
    b.textContent="0";

    b.addEventListener("pointerdown",(e)=>{
      e.preventDefault();
      s(tap);

      if(b.disabled) return;

      code[i]=(code[i]+1)%10;
      b.textContent=String(code[i]);

      const str=code.join("");

      if(str===answer){
        // 잠금: 숫자 그대로 유지
        btns.forEach(x=>x.disabled=true);

        flash("lockSuccess", 600);
        scene.classList.add("shake");
        s(unlock);

        setTimeout(()=>{
          scene.classList.remove("shake");
          scene.src=openImg;
          s(stage);

          hint.textContent="열렸다! 화면을 터치해 다음으로";
          // ✅ 자동 진행 X
          fullTap(()=>{ s(tap); nextFn(); });
        }, 450);

      }else{
        flash("lockFail", 350);
        scene.classList.add("shake");
        setTimeout(()=>scene.classList.remove("shake"),250);
      }
    }, {passive:false});

    wrap.appendChild(b);
    btns.push(b);
  }

  game.appendChild(wrap);
}

function Lock1(){ lockStage(LOCK1_ANSWER, ASSET.lock1Closed, ASSET.lock1Open, PotionStage); }
function Lock2(){ lockStage(LOCK2_ANSWER, ASSET.lock1Closed, ASSET.lock1Open, BookStage); }

/* =========================
   2) 물약 단계 (새 버전)
   - 책 아이콘 누르면 manual_popup 표시/숨김
   - 병 누르면 솥 색 바뀜 + mix/pour 사운드
   - 정답(파+갈+검) 되면 "물약 붓기" 버튼 생성(하단)
   - 틀린 조합이면 폭탄이미지 X, boom 사운드 + 다시하기 버튼만
========================= */
let selected = new Set();
let lastColor = null;

function PotionStage(){
  selected = new Set();
  lastColor = null;

  setScene(ASSET.potionBg);
  hint.textContent="책을 눌러 설명서를 보고, 물약을 섞어라";

  // 솥 색 오버레이
  const tint=document.createElement("div");
  tint.className="cauldronTint";
  game.appendChild(tint);

  // 매뉴얼 팝업
  const popup=document.createElement("img");
  popup.src=ASSET.manualPopup;
  popup.className="popup";
  popup.alt="manual";
  game.appendChild(popup);

  // 종이(붓기 단계)
  const paperImg=document.createElement("img");
  paperImg.src=ASSET.paperClean;
  paperImg.className="paper";
  paperImg.alt="paper";
  game.appendChild(paperImg);

  // 병 레이어
  const layer=document.createElement("div");
  layer.className="layer";
  layer.style.pointerEvents="none"; // 배경 레이어는 클릭X
  game.appendChild(layer);

  // 병들(실제 클릭 가능 이미지)
  const jars = [
    {id:"jar_blue",   src:ASSET.jar_blue,   key:"blue"},
    {id:"jar_black",  src:ASSET.jar_black,  key:"black"},
    {id:"jar_brown",  src:ASSET.jar_brown,  key:"brown"},
    {id:"jar_red",    src:ASSET.jar_red,    key:"red"},
    {id:"jar_yellow", src:ASSET.jar_yellow, key:"yellow"},
    {id:"jar_pink",   src:ASSET.jar_pink,   key:"pink"},
  ];

  jars.forEach(j=>{
    const img=document.createElement("img");
    img.src=j.src;
    img.id=j.id;
    img.className="potionJar";
    img.alt=j.key;
    img.onclick=()=>{
      s(pour); // 물 따르는 소리
      selected.add(j.key);
      lastColor = j.key;

      // 솥 색을 대충 반영(간단 효과)
      const colorMap = {
        blue:   "rgba(70,160,255,.35)",
        black:  "rgba(0,0,0,.45)",
        brown:  "rgba(120,70,20,.35)",
        red:    "rgba(255,60,60,.35)",
        yellow: "rgba(255,220,60,.35)",
        pink:   "rgba(255,80,180,.35)",
      };
      tint.style.background = colorMap[j.key] || "rgba(0,0,0,0)";

      // 선택이 3개가 되면 판정
      if(selected.size === 3){
        checkPotion(tint, popup, paperImg);
      }
    };
    game.appendChild(img);
  });

  // 좌상단 책 아이콘 클릭 영역(이미지에 이미 책 아이콘이 들어있다고 했으니, 그 위치에 투명버튼)
  const bookBtn=document.createElement("button");
  bookBtn.className="hs";
  bookBtn.style.left="2%";
  bookBtn.style.top="2%";
  bookBtn.style.width="14%";
  bookBtn.style.height="10%";
  bookBtn.onclick=()=>{
    s(tap);
    s(paper);
    popup.classList.toggle("show");
    hint.textContent = popup.classList.contains("show") ? "설명서를 확인해라" : "물약을 섞어라";
  };
  game.appendChild(bookBtn);

  // (처음엔 붓기 버튼 없음)
}

function checkPotion(tint, popup, paperImg){
  const ok = (selected.size===3) && [...POTION_ANSWER].every(x=>selected.has(x));

  if(!ok){
    // ❌ 폭탄이미지 없음: 소리 + 다시하기 버튼만
    s(boomS);
    hint.textContent="뻥... 조합이 틀렸다!";
    makeBtn("다시하기", ()=>{
      s(tap);
      PotionStage();
    }, {bottom: 34});
    return;
  }

  // ✅ 정답: 솥이 초록빛나게 + 물약붓기 버튼 생성
  hint.textContent="정답! 물약이 완성됐다!";
  tint.classList.add("cauldronGlow");
  tint.style.background="rgba(0,255,120,.22)";
  s(stage);

  // 하단 아래로 위치 조정(요청)
  makeBtn("물약 붓기", ()=>{
    s(tap);
    popup.classList.remove("show");
    showPaperFlow(paperImg);
  }, {bottom: 16});
}

function showPaperFlow(paperImg){
  // 종이 보여주기
  s(paper);
  paperImg.src = ASSET.paperClean;
  paperImg.classList.add("show");
  hint.textContent="종이를 한 번 터치해라";

  // 종이 1번 터치 -> revealed
  paperImg.onclick=()=>{
    s(pour);
    paperImg.src = ASSET.paperRevealed;
    hint.textContent="힌트가 나타났다!";
    paperImg.onclick=null;

    // 자물쇠 버튼 생성
    makeBtn("자물쇠", ()=>{
      s(tap);
      Lock2();
    }, {bottom: 34});
  };
}

/* =========================
   3) 책장 단계 (배경 + 책4권 PNG 클릭)
   - 자기 결정(정답) 클릭 -> key.png
   - 화면 터치 -> 3단계 자물쇠(터치 2번)
========================= */
function BookStage(){
  setScene(ASSET.bookBg);
  hint.textContent="세령공주에게 준 책을 찾아라";

  const wrap=document.createElement("div");
  wrap.className="bookWrap";
  game.appendChild(wrap);

  // 책 4권 이미지 올리기
  const books = [
    {id:"book1", src:ASSET.book1, correct:false},
    {id:"book2", src:ASSET.book2, correct:false},
    {id:"book3", src:ASSET.book3, correct:false},
    {id:"book4", src:ASSET.book4, correct:true}, // ✅ 자기 결정
  ];

  books.forEach(b=>{
    const img=document.createElement("img");
    img.id=b.id;
    img.className="book";
    img.src=b.src;
    img.alt=b.id;
    img.onclick=()=>{
      s(tap);
      if(!b.correct){
        hint.textContent="땡!";
        setTimeout(()=>hint.textContent="세령공주에게 준 책을 찾아라",700);
        return;
      }
      s(get);
      setScene(ASSET.keyScene);
      hint.textContent="열쇠 획득! 화면을 터치해 자물쇠로";
      fullTap(()=>{ s(tap); Lock3(); });
    };
    game.appendChild(img);
  });
}

/* =========================
   3단계 자물쇠 (터치 2번)
   - k3c 터치 -> k3o + 구출하러가기 버튼 생성
   - 구출하러가기 눌러야 엔딩송+엔딩화면
========================= */
function Lock3(){
  setScene(ASSET.lock3Closed);
  hint.textContent="화면을 터치해 자물쇠를 열어라";

  fullTap(()=>{
    s(unlock);
    setScene(ASSET.lock3Open);
    hint.textContent="구출하러 가기! 버튼을 눌러라";

    // ✅ 이미지에 버튼이 있더라도, 클릭 확실히 먹게 버튼을 코드로 생성
    makeBtn("구출하러가기!", ()=>{
      s(tap);
      End();
    }, {bottom: 34});
  });
}

/* =========================
   엔딩
   - 엔딩 화면 + 엔딩송
   - 1초 뒤 "편지보러가기" 버튼 생성
   - 누르면 letter.png
========================= */
function End(){
  bgm.pause(); bgm.currentTime=0;
  endbgm.volume=0.55;
  endbgm.play().catch(()=>{});

  setScene(ASSET.ending);
  hint.textContent="세령공주 구출 성공!";

  setTimeout(()=>{
    makeBtn("편지보러가기", ()=>{
      s(tap);
      setScene(ASSET.letter);
      hint.textContent="";
    }, {bottom: 34});
  }, 1000);
}

/* 시작 */
S0();
</script>
</body>
</html>
