<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>세령공주 구출</title>

<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  .game{position:fixed;inset:0;touch-action:manipulation}
  .img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

  /* 상단 안내 */
  .hintText{
    position:absolute;top:14px;left:0;right:0;
    text-align:center;color:#fff;font-weight:900;
    text-shadow:0 2px 10px rgba(0,0,0,.85);
    padding:0 12px;z-index:9999;pointer-events:none;
    letter-spacing:-.3px;
  }

  /* 전체 터치 버튼(투명) */
  .hsFull{position:absolute;inset:0;border:0;background:transparent;z-index:9000;-webkit-tap-highlight-color:transparent}

  /* 공통 버튼 */
  .bigBtn{
    position:absolute;left:50%;transform:translateX(-50%);
    bottom:18px;
    border:0;border-radius:16px;
    padding:14px 18px;
    font-weight:900;font-size:18px;
    background:rgba(255,255,255,.92);
    color:#000;
    box-shadow:0 10px 24px rgba(0,0,0,.45);
    z-index:9999;
    -webkit-tap-highlight-color:transparent;
  }
  .bigBtn:active{transform:translateX(-50%) scale(.98)}

  /* 벽 이동 UI */
  .uiBar{position:absolute;left:0;right:0;bottom:20px;display:none;justify-content:center;gap:12px;z-index:9999}
  .uiBtn{
    border:0;border-radius:50%;
    width:64px;height:64px;
    font-size:28px;font-weight:900;
    background:rgba(255,255,255,.92);
    color:#000;
    box-shadow:0 6px 20px rgba(0,0,0,.55);
    -webkit-tap-highlight-color:transparent;
  }
  .uiBtn:active{transform:scale(.97)}
  .uiNext{
    position:absolute;right:16px;bottom:100px;
    border:0;border-radius:14px;
    padding:12px 16px;
    font-weight:900;font-size:16px;
    background:#ff4d6d;color:#fff;
    display:none; z-index:9999;
    -webkit-tap-highlight-color:transparent;
  }
  .uiNext.show{display:block}
  .uiNext:active{transform:scale(.98)}

  /* 자물쇠 숫자 버튼 */
  :root{
    --lock-x: 22%;
    --lock-y: 50%;
    --lock-w: 56%;
    --lock-h: 9%;
  }
  .lockDigits{
    position:absolute;
    left:var(--lock-x);
    top:var(--lock-y);
    width:var(--lock-w);
    height:var(--lock-h);
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:4%;
    z-index:9999;
  }
  .digitBtn{
    border:0;border-radius:14px;
    background:rgba(0,0,0,.45);
    color:#fff;
    font-weight:900;
    font-size:clamp(18px, 6vw, 34px);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.14), 0 8px 18px rgba(0,0,0,.35);
    -webkit-tap-highlight-color:transparent;
  }
  .digitBtn:active{transform:scale(.97)}
  .lockSuccess{ animation: glowGreen .6s ease; }
  @keyframes glowGreen{0%{box-shadow:0 0 0px #00ff88}50%{box-shadow:0 0 26px #00ff88}100%{box-shadow:0 0 0px #00ff88}}
  .lockFail{ animation: glowRed .35s ease; }
  @keyframes glowRed{0%{box-shadow:0 0 0px #ff3b30}50%{box-shadow:0 0 22px #ff3b30}100%{box-shadow:0 0 0px #ff3b30}}
  .shake{ animation: shakeLock .32s ease; }
  @keyframes shakeLock{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}

  /* ====== 2단계 물약방 ====== */
  .layer{position:absolute;inset:0;z-index:20;pointer-events:none}
  .potionJar{
    position:absolute;z-index:40;
    width:16%;
    pointer-events:auto;
    -webkit-tap-highlight-color:transparent;
    user-select:none;
  }
  .potionJar:active{transform:scale(.98)}

  /* 솥 색 틴트(믹스) */
  .cauldronTint{
    position:absolute;z-index:30;
    left:22%; top:40%;
    width:56%; height:22%;
    border-radius:999px;
    background:rgba(0,255,200,.0);
    mix-blend-mode:screen;
    filter:blur(2px);
    pointer-events:none;
  }
  .cauldronGlow{
    animation: cauldronPulse 1.4s ease-in-out infinite;
  }
  @keyframes cauldronPulse{
    0%{opacity:.25}
    50%{opacity:.75}
    100%{opacity:.25}
  }
  /* 거품 */
  .bubble{
    position:absolute;z-index:35;
    left:30%; top:40%;
    width:40%; height:22%;
    pointer-events:none;
    overflow:hidden;
  }
  .bubble span{
    position:absolute;bottom:-20px;
    width:10px;height:10px;border-radius:50%;
    background:rgba(255,255,255,.55);
    animation: bubbleUp 1.6s linear infinite;
  }
  @keyframes bubbleUp{
    0%{transform:translateY(0) scale(.8); opacity:0}
    20%{opacity:.9}
    100%{transform:translateY(-220px) scale(1.2); opacity:0}
  }

  /* 매뉴얼 팝업 */
  .popup{
    position:absolute;z-index:9998;
    left:50%; top:50%;
    transform:translate(-50%,-50%);
    width:min(82vw,420px);
    border-radius:16px;
    box-shadow:0 18px 50px rgba(0,0,0,.6);
    pointer-events:auto;
  }

  /* 종이 */
  .paper{
    position:absolute;z-index:9998;
    left:50%; top:54%;
    transform:translate(-50%,-50%);
    width:min(78vw,420px);
    pointer-events:auto;
  }

  /* ====== 3단계 책방 ====== */
  .bookWrap{position:absolute;inset:0;z-index:60;pointer-events:none}
  .book{
    position:absolute;z-index:70;
    width:17%;
    pointer-events:auto;
    -webkit-tap-highlight-color:transparent;
    user-select:none;
  }
  .book:active{transform:scale(.98)}
</style>
</head>

<body>
<div class="game" id="game">
  <img id="scene" class="img" alt="scene">
  <div class="hintText" id="hint"></div>

  <div class="uiBar" id="wallUI">
    <button class="uiBtn" id="btnL">◀</button>
    <button class="uiBtn" id="btnC">▲</button>
    <button class="uiBtn" id="btnR">▶</button>
  </div>
  <button class="uiNext" id="btnNext">다음 ▶</button>
</div>

<!-- 사운드 -->
<audio id="bgm" src="bgm.mp3" loop></audio>
<audio id="endbgm" src="end.mp3" loop></audio>
<audio id="tap" src="tap.mp3"></audio>
<audio id="unlock" src="unlock.mp3"></audio>
<audio id="mix" src="mix.mp3"></audio>
<audio id="pour" src="pour.mp3"></audio>
<audio id="paperS" src="paper.mp3"></audio>
<audio id="get" src="get.mp3"></audio>
<audio id="stage" src="stage.mp3"></audio>
<audio id="drawer" src="drawer.mp3"></audio>
<audio id="boom" src="boom.mp3"></audio>
<audio id="rrbgm" src="rr.mp3" loop></audio>

<script>
/* =========================
   ✅ 파일명(여기만 맞추면 됨)
========================= */
const ASSET = {
  // 시작~1단계
  s0: "s0.png",
  s1: "s1.png",
  f0: "f0.png",
  drawerOpen: "k2c.png",
  flashGet: "flash.png",
  fl: "fl.png",
  fc: "fc.png",
  fr: "fr.png",
  lock1Closed: "k1c.png",
  lock1Open: "k1o.png",

  // 2단계(새 구성)
  potionBg: "bg_potion_room.png",
  jarBlue: "jar_blue.png",
  jarBrown: "jar_brown.png",
  jarBlack: "jar_black.png",
  jarRed: "jar_red.png",
  jarYellow: "jar_yellow.png",
  jarPink: "jar_pink.png",
  manualPopup: "manual_popup.png",
  paperClean: "paper_clean.png",
  paperRevealed: "paper_revealed.png",

  // 2단계 자물쇠는 1단계랑 동일 이미지 사용
  lock2Closed: "k1c.png",
  lock2Open: "k1o.png",

  // 3단계(새 책방)
  bookshelfBg: "b0.png",
  keyScene: "key.png",

  // ⚠️ 여기 파일명 너꺼랑 다르면 바꿔!
  book1: "book1.png", // 노인과 바다
  book2: "book2.png", // 너의 결정
  book3: "book3.png", // 급류
  book4: "book4.png", // 자기 결정(정답)

  lock3Closed: "k3c.png",
  lock3Open: "k3o.png",

  end: "end.png",
  letter: "letter.png"
};

/* =========================
   기본 DOM
========================= */
const game = document.getElementById("game");
const scene = document.getElementById("scene");
const hint = document.getElementById("hint");

const wallUI = document.getElementById("wallUI");
const btnL = document.getElementById("btnL");
const btnC = document.getElementById("btnC");
const btnR = document.getElementById("btnR");
const btnNext = document.getElementById("btnNext");

const bgm = document.getElementById("bgm");
const endbgm = document.getElementById("endbgm");
const tap = document.getElementById("tap");
const unlock = document.getElementById("unlock");
const mix = document.getElementById("mix");
const pour = document.getElementById("pour");
const paperS = document.getElementById("paperS");
const get = document.getElementById("get");
const stage = document.getElementById("stage");
const drawer = document.getElementById("drawer");
const boom = document.getElementById("boom");
const rrbgm = document.getElementById("rrbgm");

function s(a){ try{ a.currentTime=0; a.play(); }catch(e){} }
 function playFor(audioEl, ms){
  try{
    audioEl.currentTime = 0;
    audioEl.play();
    setTimeout(()=>{
      try{ audioEl.pause(); }catch(e){}
    }, ms);
  }catch(e){}
}
/* =========================
   ✅ 겹침 방지: “장면 바뀔 때” 오버레이 싹 제거
========================= */
function clearOverlays(){
  // 우리가 추가로 만든 것들만 싹 지움
  game.querySelectorAll(".hsFull,.bigBtn,.lockDigits,.layer,.popup,.paper,.cauldronTint,.bubble,.potionJar,.bookWrap,.book").forEach(el=>el.remove());
}

/* 장면 세팅 */
function setScene(src){
  clearOverlays();
  scene.src = src;
  hint.textContent = "";
  wallUI.style.display = "none";
  btnNext.classList.remove("show");
}

/* 화면 전체 터치 */
function fullTap(nextFn){
  const b=document.createElement("button");
  b.className="hsFull";
  b.onclick=()=>{ b.remove(); nextFn && nextFn(); };
  game.appendChild(b);
}

/* 버튼 만들기 */
function makeBtn(text, onClick, opts={}){
  const b=document.createElement("button");
  b.className="bigBtn";
  b.textContent=text;
  if(opts.bottom!=null) b.style.bottom = opts.bottom+"px";
  if(opts.bg) b.style.background = opts.bg;
  if(opts.color) b.style.color = opts.color;
  b.onclick=onClick;
  game.appendChild(b);
  return b;
}

/* =========================
   시작
========================= */
function S0(){
  setScene(ASSET.s0);
  fullTap(()=>{
    s(tap);
    bgm.volume=.35;
    bgm.play().catch(()=>{});
    S1();
  });
}
function S1(){
  setScene(ASSET.s1);
  fullTap(()=>{ s(tap); F0(); });
}

/* =========================
   손전등 방
========================= */
function F0(){
  setScene(ASSET.f0);
  hint.textContent="책상을 눌러라";
  fullTap(()=>{ s(drawer); F1(); });
}
function F1(){
  setScene(ASSET.drawerOpen);
  hint.textContent="서랍을 확인해라";
  fullTap(()=>{ s(get); F2(); });
}
function F2(){
  setScene(ASSET.flashGet);
  hint.textContent="손전등 획득!";
  setTimeout(()=>WallStart(), 900);
}

/* =========================
   벽(정면→왼/오 이동)
========================= */
let sawHintWall=false;
function WallStart(){
  sawHintWall=false;
  showWall("c");
}
function showWall(where){
  if(where==="l"){ setScene(ASSET.fl); sawHintWall=true; }
  if(where==="c"){ setScene(ASSET.fc); }
  if(where==="r"){ setScene(ASSET.fr); }

  wallUI.style.display="flex";
  hint.textContent = sawHintWall ? "힌트를 찾았다!" : "어디에 힌트가 있을까…?";

  btnL.onclick=()=>{ s(tap); showWall("l"); };
  btnC.onclick=()=>{ s(tap); showWall("c"); };
  btnR.onclick=()=>{ s(tap); showWall("r"); };

  if(sawHintWall) btnNext.classList.add("show");
  else btnNext.classList.remove("show");

  btnNext.onclick=()=>{
    if(!sawHintWall) return;
    s(tap);
    Lock1();
  };
}

/* =========================
   ✅ 자물쇠(1/2단계 공용)
   - 정답이면 열린 이미지로 바꾸고
   - "화면 터치" 해야 다음 단계로 넘어감
========================= */
function lockStage(answer, closedImg, openImg, nextFn){
  setScene(closedImg);
  hint.textContent="숫자를 눌러 비밀번호를 맞춰라";

  const wrap=document.createElement("div");
  wrap.className="lockDigits";
  const code=[0,0,0,0];
  const btns=[];

  const flash=(cls, ms)=>btns.forEach(b=>{
    b.classList.add(cls);
    setTimeout(()=>b.classList.remove(cls), ms);
  });

  for(let i=0;i<4;i++){
    const b=document.createElement("button");
    b.className="digitBtn";
    b.textContent="0";
    b.addEventListener("pointerdown",(e)=>{
      e.preventDefault();
      if(b.disabled) return;
      s(tap);
      code[i]=(code[i]+1)%10;
      b.textContent=String(code[i]);

      const str=code.join("");
      if(str===answer){
        btns.forEach(x=>x.disabled=true);
        flash("lockSuccess", 600);
        scene.classList.add("shake");
        s(unlock);

        setTimeout(()=>{
          scene.classList.remove("shake");
          scene.src=openImg;
          s(stage);
          hint.textContent="성공! 화면을 터치해 다음으로";
          fullTap(()=>{ s(tap); nextFn(); });
        }, 450);

      }else{
        flash("lockFail", 350);
      }
    }, {passive:false});
    wrap.appendChild(b);
    btns.push(b);
  }
  game.appendChild(wrap);
}

function Lock1(){ lockStage("1019", ASSET.lock1Closed, ASSET.lock1Open, Potion2Start); }
function Lock2(){ lockStage("0506", ASSET.lock2Closed, ASSET.lock2Open, Books3Start); }

/* =========================
   ✅ 2단계 물약방(새 구성)
   목표: 파랑+갈색+검정 선택(총 3개)
   - 틀리면 폭발소리 + 다시하기 버튼만
   - 성공하면 '물약 붓기' 버튼(하단)
   - 물약 붓기 버튼 누르면: 종이(깨끗→번짐 자동) + 자물쇠 버튼 생성
========================= */
let potionPicked = [];
let potionLocked = false; // 성공/실패 후 더 못 누르게
let tintEl = null;

function Potion2Start(){
  potionPicked = [];
  potionLocked = false;

  setScene(ASSET.potionBg);
  hint.textContent="책을 눌러 설명서를 확인하고, 물약 3개를 골라라";

  // 솥 색 틴트 + 거품 레이어
  tintEl = document.createElement("div");
  tintEl.className="cauldronTint cauldronGlow";
  game.appendChild(tintEl);

  const bubble = document.createElement("div");
  bubble.className="bubble";
  for(let i=0;i<10;i++){
    const sp=document.createElement("span");
    sp.style.left = Math.random()*100 + "%";
    sp.style.animationDelay = (Math.random()*1.2) + "s";
    sp.style.width = sp.style.height = (6+Math.random()*10) + "px";
    bubble.appendChild(sp);
  }
  game.appendChild(bubble);

  // 매뉴얼(좌상단 책 아이콘 위치에 핫스팟) - 배경에 아이콘 있으니 좌표만
  const manualHot = document.createElement("button");
  manualHot.className="layer";
  manualHot.style.pointerEvents="auto";
  manualHot.style.zIndex="9997";
  manualHot.style.left="2%";
  manualHot.style.top="1.5%";
  manualHot.style.width="16%";
  manualHot.style.height="12%";
  manualHot.style.background="transparent";
  manualHot.style.border="0";
  manualHot.onclick=()=>{
    if(potionLocked) return;
    s(tap);
    showManualPopup();
  };
  game.appendChild(manualHot);

  // 병 배치(6개) - 화면 아래 선반 기준으로 깔끔하게
  // (필요하면 x/y만 조금 조절)
  const jars = [
    {key:"blue",  src:ASSET.jarBlue,   x:30, y:70},
    {key:"brown", src:ASSET.jarBrown,  x:45, y:70},
    {key:"black", src:ASSET.jarBlack,  x:60, y:70},
    {key:"red",   src:ASSET.jarRed,    x:75, y:70},
    {key:"yellow",src:ASSET.jarYellow, x:40, y:83},
    {key:"pink",  src:ASSET.jarPink,   x:65, y:83},
  ];
  jars.forEach(j=>addJar(j.key, j.src, j.x, j.y));
}

function showManualPopup(){
  // 이미 떠있으면 닫기
  const old = game.querySelector(".popup");
  if(old){ old.remove(); return; }

  s(paperS);
  const img=document.createElement("img");
  img.src=ASSET.manualPopup;
  img.className="popup";
  img.onclick=()=>{ s(paperS); img.remove(); };
  game.appendChild(img);
}

function addJar(key, src, x, y){
  const img=document.createElement("img");
  img.src=src;
  img.className="potionJar";
  img.style.left=x+"%";
  img.style.top=y+"%";
  img.style.transform="translate(-50%,-50%)";
  img.onclick=()=>{
    if(potionLocked) return;
    playFor(mix, 1500);

    // 솥 색 바꾸기(효과)
    setCauldronColor(key);

    potionPicked.push(key);

    // 3개 선택하면 판정
    if(potionPicked.length>=3){
      potionLocked = true;
      const ok = isPotionCorrect(potionPicked);
      if(ok){
        s(stage);
        hint.textContent="정답! 물약을 완성했다!";
        tintEl.style.background="rgba(0,255,120,.42)";
        // 물약 붓기 버튼 (하단 아래)
        makeBtn("물약 붓기", ()=>{
          s(tap);
          showPaperFlow();
        }, {bottom: 12});
      }else{
        // ❌ 폭탄이미지 없음, 소리 + 다시하기 버튼만
        s(boom);
        hint.textContent="틀렸다! 다시 시도해!";
        makeBtn("다시하기", ()=>{
          s(tap);
          Potion2Start();
        }, {bottom: 12});
      }
    }
  };
  game.appendChild(img);
}

function setCauldronColor(key){
  const colorMap = {
    blue:   "rgba(80,170,255,.40)",
    brown:  "rgba(160,110,60,.40)",
    black:  "rgba(90,90,110,.35)",
    red:    "rgba(255,70,70,.38)",
    yellow: "rgba(255,230,80,.38)",
    pink:   "rgba(255,110,210,.38)"
  };
  if(!tintEl) return;
  tintEl.style.background = colorMap[key] || "rgba(0,255,200,.25)";
}

function isPotionCorrect(arr){
  // 정답: blue + brown + black (순서 무관, 3개 선택 기준)
  const need = ["blue","brown","black"].sort().join(",");
  const got  = [...arr].slice(0,3).sort().join(",");
  return got === need;
}
function showPaperFlow(){

  game.querySelectorAll(".bigBtn").forEach(b=>b.remove());

  hint.textContent="종이를 터치하여 물약을 부어라";
  s(paperS);

  const paperImg=document.createElement("img");
  paperImg.className="paper";
  paperImg.src=ASSET.paperClean;
  game.appendChild(paperImg);

  // ✅ 종이를 눌러야 번짐
  paperImg.onclick=()=>{
    s(pour);
    paperImg.src=ASSET.paperRevealed;
    hint.textContent="힌트가 드러났다!";

    // 다시 못누르게
    paperImg.onclick=null;

    // ✅ 이제 자물쇠 버튼 생성
    makeBtn("자물쇠", ()=>{
      s(tap);
      Lock2();
    }, {bottom: 70});
  };
}

/* =========================
   ✅ 3단계 책방(새 방식)
   - 책 배경(b0.png) + 투명책 4권을 “책장 안에” 배치
   - 정답: 자기 결정(book4)
========================= */
function Books3Start(){
  setScene(ASSET.bookshelfBg);
  hint.textContent="세령공주에게 준 책을 찾아라";

  const wrap=document.createElement("div");
  wrap.className="bookWrap";
  game.appendChild(wrap);

  // 배경 책장에 잘 들어가게 2×2 배치
  const books = [
    {id:"book1", src:ASSET.book1, x:41, y:34, ok:false},
    {id:"book2", src:ASSET.book2, x:59, y:34, ok:false},
    {id:"book3", src:ASSET.book3, x:41, y:61, ok:false},
    {id:"book4", src:ASSET.book4, x:59, y:61, ok:true},  // ✅ 정답(자기 결정)
  ];

  books.forEach(b=>{
    const img=document.createElement("img");
    img.src=b.src;
    img.className="book";
    img.style.left=b.x+"%";
    img.style.top=b.y+"%";
    img.style.transform="translate(-50%,-50%)";
    img.onclick=()=>{
      s(tap);
      if(!b.ok){
        const prev = hint.textContent;
        hint.textContent="땡!";
        setTimeout(()=>hint.textContent=prev, 600);
        return;
      }
      s(get);
      setScene(ASSET.keyScene);
      hint.textContent="열쇠 획득! 화면을 터치해 자물쇠로";
      fullTap(()=>{ s(tap); Lock3(); });
    };
    game.appendChild(img);
  });
}

/* =========================
   마지막 자물쇠(3단계)
   - 닫힘 터치 → 열림
   - 열림 화면 터치 → 엔딩
========================= */
function Lock3(){
  setScene(ASSET.lock3Closed);
  hint.textContent="화면을 터치해 자물쇠를 열어라";
  fullTap(()=>{
    s(unlock);
    setScene(ASSET.lock3Open);
    hint.textContent="구출하러 가기!";
    fullTap(()=>{ s(tap); End(); });
  });
}

/* =========================
   엔딩 + 1초 후 편지 버튼
========================= */
function End(){
  bgm.pause(); bgm.currentTime=0;
  endbgm.volume=.55;
  endbgm.play().catch(()=>{});
  setScene(ASSET.end);
  hint.textContent="세령공주 구출 성공!";

  setTimeout(()=>{
    makeBtn("편지 보러가기", ()=>{
      s(tap);
  
      try{ endbgm.pause(); endbgm.currentTime = 0; }catch(e){}
      try{ rrbgm.volume = .55; rrbgm.currentTime = 0; rrbgm.play(); }catch(e){}

      setScene(ASSET.letter);
      hint.textContent="";
    }, {bottom: 22});
  }, 1000);
}

S0();
</script>
</body>
</html>
