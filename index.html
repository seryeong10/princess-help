<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>세령공주 구출</title>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden}
.game{position:fixed;inset:0;background:#000}
.img{
  position:absolute;inset:0;width:100%;height:100%;
  object-fit:cover;object-position:center;
}
.img.contain{object-fit:contain;background:#000}

.hs{
  position:absolute;border:0;background:transparent;
  -webkit-tap-highlight-color:transparent;
  z-index:99990;
}
.hs:active{transform:scale(.96)}

.hintText{
  position:absolute;top:14px;left:0;right:0;
  text-align:center;color:#fff;font-weight:800;
  text-shadow:0 2px 10px rgba(0,0,0,.8);
  padding:0 14px;z-index:99995;pointer-events:none;
}

.uiNext{
  position:absolute;right:16px;bottom:100px;
  border:0;border-radius:14px;
  padding:12px 16px;
  font-weight:900;font-size:16px;
  background:#ff4d6d;color:#fff;
  display:none; z-index:99995;
}
.uiNext.show{display:block}

/* 폭탄 오버레이(선택) */
#boomOverlay{
  position:absolute;inset:0;width:100%;height:100%;
  object-fit:contain;opacity:0;pointer-events:none;
  z-index:99980;
}

/* 물줄기 */
#stream{
  position:absolute;
  left:50%;
  top:20%;
  width:34%;
  transform:translateX(-50%) translateY(-80px);
  opacity:0;
  pointer-events:none;
  z-index:99970;
}
@keyframes dropLong{
  0%   {opacity:1; transform:translateX(-50%) translateY(-80px)}
  100% {opacity:1; transform:translateX(-50%) translateY(520px)}
}

/* ===== 솥 물색 + 발광 + 거품 ===== */
#cauldronGlow{
  position:absolute;
  left:33%;
  top:56%;
  width:34%;
  height:16%;
  border-radius:50%;
  pointer-events:none;
  background:transparent;
  opacity:0;
  transition: background .6s ease, opacity .6s ease, box-shadow .8s ease;
  z-index:20;
  filter: blur(0.2px);
}
#cauldronGlow.on{
  opacity:.75;
  box-shadow:
    0 0 18px rgba(0,255,150,.55),
    0 0 42px rgba(0,255,150,.35);
}

#bubbleLayer{
  position:absolute;
  left:33%;
  top:56%;
  width:34%;
  height:16%;
  overflow:hidden;
  border-radius:50%;
  pointer-events:none;
  z-index:25;
  opacity:0;
  transition: opacity .5s ease;
}
#bubbleLayer.on{opacity:1}

.bubble{
  position:absolute;
  bottom:-12px;
  width:10px;height:10px;
  border-radius:50%;
  background:rgba(255,255,255,.55);
  box-shadow:0 0 10px rgba(255,255,255,.25);
  animation: bubbleUp 1.8s linear forwards;
}
@keyframes bubbleUp{
  0%{transform:translateY(0) scale(.85);opacity:.0}
  15%{opacity:.85}
  100%{transform:translateY(-120px) scale(1.25);opacity:0}
}

/* ===== 자물쇠 숫자 버튼 ===== */
:root{
  --lock-x: 22%;
  --lock-y: 50%;
  --lock-w: 56%;
  --lock-h: 9%;
}
.lockDigits{
  position:absolute;
  left:var(--lock-x); top:var(--lock-y);
  width:var(--lock-w); height:var(--lock-h);
  display:grid; grid-template-columns:repeat(4,1fr);
  gap:4%;
  z-index:99995;
}
.digitBtn{
  border:0;border-radius:14px;
  background:rgba(0,0,0,.45);
  color:#fff;font-weight:900;
  font-size:clamp(18px, 6vw, 34px);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.14), 0 8px 18px rgba(0,0,0,.35);
  -webkit-tap-highlight-color:transparent;
}
.digitBtn:active{transform:scale(.97)}
.digitBtn:disabled{opacity:.95}
.lockSuccess{ animation: glowGreen .6s ease; }
@keyframes glowGreen{
 0%{box-shadow:0 0 0px #00ff88;}
 50%{box-shadow:0 0 25px #00ff88;}
 100%{box-shadow:0 0 0px #00ff88;}
}
.lockFail{ animation: glowRed .4s ease; }
@keyframes glowRed{
 0%{box-shadow:0 0 0px #ff0000;}
 50%{box-shadow:0 0 25px #ff0000;}
 100%{box-shadow:0 0 0px #ff0000;}
}
.shake{ animation: shakeLock .35s ease; }
@keyframes shakeLock{
 0%{transform:translateX(0)}
 25%{transform:translateX(-6px)}
 50%{transform:translateX(6px)}
 75%{transform:translateX(-4px)}
 100%{transform:translateX(0)}
}
</style>
</head>
<body>

<div class="game" id="game">
  <img id="scene" class="img" alt="scene">
  <div id="cauldronGlow"></div>
  <div id="bubbleLayer"></div>
  <img id="stream" alt="stream">
  <img id="boomOverlay" src="boom.png" alt="boom">
  <div class="hintText" id="hint"></div>
</div>

<!-- 사운드 -->
<audio id="bgm" src="bgm.mp3" loop></audio>
<audio id="endbgm" src="end.mp3" loop></audio>
<audio id="tap" src="tap.mp3"></audio>
<audio id="unlock" src="unlock.mp3"></audio>
<audio id="mix" src="mix.mp3"></audio>
<audio id="paper" src="paper.mp3"></audio>
<audio id="get" src="get.mp3"></audio>
<audio id="stage" src="stage.mp3"></audio>
<audio id="drawer" src="drawer.mp3"></audio>
<audio id="boomS" src="boom.mp3"></audio>

<script>
/* ===== 공통 ===== */
const scene=document.getElementById("scene");
const game=document.getElementById("game");
const stream=document.getElementById("stream");
const boomOverlay=document.getElementById("boomOverlay");
const hint=document.getElementById("hint");
const cauldronGlow=document.getElementById("cauldronGlow");
const bubbleLayer=document.getElementById("bubbleLayer");

const bgm=document.getElementById("bgm");
const endbgm=document.getElementById("endbgm");
const tap=document.getElementById("tap");
const unlock=document.getElementById("unlock");
const mix=document.getElementById("mix");
const paper=document.getElementById("paper");
const get=document.getElementById("get");
const stage=document.getElementById("stage");
const drawer=document.getElementById("drawer");
const boomS=document.getElementById("boomS");

function s(a){ try{a.currentTime=0;a.play();}catch{} }

let bubbleTimer=null;

function stopBubbles(){
  if(bubbleTimer){ clearInterval(bubbleTimer); bubbleTimer=null; }
  bubbleLayer.classList.remove("on");
  bubbleLayer.innerHTML="";
}
function startBubbles(intensity=1){
  stopBubbles();
  bubbleLayer.classList.add("on");
  const interval = Math.max(220, 520 - intensity*70);
  bubbleTimer = setInterval(()=>{
    const b=document.createElement("div");
    b.className="bubble";
    const size = 6 + Math.random()*10;
    b.style.width=size+"px";
    b.style.height=size+"px";
    b.style.left = (Math.random()*92)+"%";
    b.style.animationDuration = (1.3 + Math.random()*1.1) + "s";
    bubbleLayer.appendChild(b);
    setTimeout(()=>b.remove(), 2400);
  }, interval);
}

function clearOverlays(){
  document.querySelectorAll(".lockDigits").forEach(el=>el.remove());
  document.querySelectorAll(".hsFull").forEach(el=>el.remove());
  document.querySelectorAll(".hsSpot").forEach(el=>el.remove());
  document.querySelectorAll(".uiNextTemp").forEach(el=>el.remove());
}

function setScene(src, fit="cover"){
  clearOverlays();
  hint.textContent="";
  scene.classList.toggle("contain", fit==="contain");
  scene.src = src;

  // 물약/거품/발광 리셋
  cauldronGlow.classList.remove("on");
  cauldronGlow.style.background="transparent";
  cauldronGlow.style.opacity=0;
  stopBubbles();

  // 폭탄 오버레이 숨김
  boomOverlay.style.opacity=0;
}

function fullTap(nextFn){
  const b=document.createElement("button");
  b.className="hs hsFull";
  b.style.left="0"; b.style.top="0"; b.style.width="100%"; b.style.height="100%";
  b.onclick=()=>{ b.remove(); nextFn(); };
  game.appendChild(b);
}

function addHS(x,y,w,h,fn){
  const b=document.createElement("button");
  b.className="hs hsSpot";
  b.style.left=x+"%"; b.style.top=y+"%";
  b.style.width=w+"%"; b.style.height=h+"%";
  b.onclick=fn;
  game.appendChild(b);
}

function makeBottomNext(label){
  const b=document.createElement("button");
  b.className="uiNext show uiNextTemp";
  b.textContent=label;
  game.appendChild(b);
  return b;
}

/* ===== 자물쇠(성공 후 터치해야 다음) ===== */
function lockStageWithTapToNext(answer, closedImg, openImg, nextFn){
  setScene(closedImg, "cover");
  hint.textContent="숫자를 눌러 비밀번호를 맞춰라";

  const wrap=document.createElement("div");
  wrap.className="lockDigits";
  const code=[0,0,0,0];
  const btns=[];

  function flash(cls, ms){
    btns.forEach(b=>{
      b.classList.add(cls);
      setTimeout(()=>b.classList.remove(cls), ms);
    });
  }
  function onSuccess(){
    btns.forEach(b=> b.disabled=true);
    flash("lockSuccess",600);
    scene.classList.add("shake");
    s(unlock);

    setTimeout(()=>{
      scene.classList.remove("shake");
      scene.src=openImg;
      s(stage);
      hint.textContent="성공! 화면을 터치해 다음 단계로";
      fullTap(()=>{ s(tap); nextFn(); });
    },500);
  }
  function onFail(){
    flash("lockFail",350);
    scene.classList.add("shake");
    setTimeout(()=>scene.classList.remove("shake"),200);
  }

  for(let i=0;i<4;i++){
    const b=document.createElement("button");
    b.className="digitBtn";
    b.textContent="0";
    b.addEventListener("pointerdown",(e)=>{
      e.preventDefault();
      if(b.disabled) return;
      s(tap);
      code[i]=(code[i]+1)%10;
      b.textContent=String(code[i]);
      if(code.join("")===answer) onSuccess();
      else onFail();
    }, {passive:false});
    wrap.appendChild(b);
    btns.push(b);
  }
  game.appendChild(wrap);
}

/* ===== 물줄기 ===== */
const colorMap={
  blue:"q1.png", brown:"q2.png", black:"q3.png",
  purple:"q4.png", skin:"q5.png", red:"q6.png",
  pink:"q7.png", lime:"q8.png", yellow:"q9.png"
};
function playStream(key){
  stream.src = colorMap[key];
  stream.style.opacity=1;
  stream.style.animation="none"; void stream.offsetWidth;
  stream.style.animation="dropLong 1.1s linear forwards";
  setTimeout(()=>{ stream.style.opacity=0; }, 1150);
}

/* ===== 솥 물색(선택할수록 진해짐) ===== */
const cauldronTint={
  blue:"rgba(0,120,255,.35)",
  brown:"rgba(120,70,20,.35)",
  black:"rgba(0,0,0,.42)",
  red:"rgba(255,0,0,.33)",
  yellow:"rgba(255,220,0,.33)",
  purple:"rgba(160,0,255,.33)",
  skin:"rgba(255,210,180,.33)",
  pink:"rgba(255,80,150,.33)",
  lime:"rgba(120,255,0,.33)"
};
function setCauldronColor(key, level){
  const c = cauldronTint[key] || "rgba(0,255,200,.25)";
  cauldronGlow.style.background = c;
  cauldronGlow.style.opacity = Math.min(0.25 + level*0.14, 0.78);
}

/* ===== 게임 흐름 (여기서는 1단계 자물쇠까지는 바로 간다고 가정) ===== */
function Start(){
  // 네 프로젝트에서 이미 S0/S1/손전등/벽이 완성되어 있으면
  // 여기 Start() 대신 그 흐름 끝에서 Lock1() 호출하면 됨.
  // 지금은 테스트용으로 바로 1단계 자물쇠로 시작.
  bgm.volume=.35; bgm.play().catch(()=>{});
  Lock1();
}

function Lock1(){
  lockStageWithTapToNext("1019","k1c.png","k1o.png",Potion);
}

/* ===== 2단계: 물약방(요구사항 그대로) ===== */
function Potion(){
  let selected = new Set();
  let lastKey = null;
  let mixLevel = 0;
  let solved = false;

  showP0();

  function resetToP0(){
    selected = new Set();
    lastKey = null;
    mixLevel = 0;
    solved = false;
    showP0();
  }

  function showP0(){
    // ✅ 클릭 정확도를 위해 contain
    setScene("p0.png","contain");
    hint.textContent = solved ? "정답이다! 화면을 터치해 종이를 확인하자" : "물약을 3개 섞어 힌트를 찾아라";

    // 거품은 선택할수록 빨라짐
    startBubbles(Math.min(6, 1 + mixLevel));

    // ✅ 책(설명서) - 왼쪽 하단
    addHS(5, 73, 20, 20, ()=>{
      s(paper);
      showManual();
    });

    // ✅ 병 좌표(이미지 기준)
    // 정답 3개
    addBottle(12, 28, "black");   // 검정(정답)
    addBottle(42, 30, "brown");   // 갈색(정답)
    addBottle(33, 63, "blue");    // 파랑(정답)

    // 오답들
    addBottle(20, 35, "pink");    // 핑크
    addBottle(55, 28, "purple");  // 보라
    addBottle(66, 35, "skin");    // 살색
    addBottle(8,  63, "red");     // 빨강(하단)
    addBottle(20, 67, "lime");    // 연두
    addBottle(48, 63, "yellow");  // 노랑(하단)

    // 상단 중복(요청)
    addBottle(68, 30, "skin");    // 살색 중복
    addBottle(76, 30, "yellow");  // 노랑 중복
    addBottle(86, 30, "red");     // 빨강 중복

    // ✅ 정답이면 “다음버튼 생성” + “화면 터치하면 종이”
    if(solved){
      cauldronGlow.classList.add("on"); // 초록빛 발광은 아래에서 켬
      const nextBtn = makeBottomNext("다음 ▶");
      nextBtn.style.display="block";

      // 버튼 눌러도 되고, 화면 아무데나 터치해도 넘어가게
      nextBtn.onclick = ()=>{ s(tap); showPaper0(); };
      fullTap(()=>{ s(tap); showPaper0(); });
    }
  }

  function showManual(){
    setScene("m0.png","contain");
    hint.textContent="화면을 터치하면 닫힘";
    fullTap(()=>{ s(tap); showP0(); });
  }

  function addBottle(x,y,key){
    addHS(x, y, 12, 16, ()=>{
      if(solved) return;

      s(mix);
      lastKey = key;
      selected.add(key);
      mixLevel++;

      // 액체 떨어짐 + 솥 색 변화 + 거품 속도 증가
      playStream(key);
      setCauldronColor(key, mixLevel);
      startBubbles(Math.min(6, 1 + mixLevel));

      checkMix();
    });
  }

  function checkMix(){
    const ok =
      selected.size===3 &&
      selected.has("blue") &&
      selected.has("brown") &&
      selected.has("black");

    // 3개 이상인데 정답이 아니면 폭탄
    if(selected.size>=3 && !ok){
      bomb();
      return;
    }

    // 정답이면: 솥이 천천히 초록빛으로 빛나고 다음버튼 생성 + 터치로 종이
    if(ok){
      solved = true;
      s(stage);

      // 초록색으로 천천히 전환
      cauldronGlow.style.background = "rgba(0,255,150,.38)";
      cauldronGlow.style.opacity = 0.75;
      cauldronGlow.classList.add("on");

      hint.textContent="정답이다!";
      showP0();
    }
  }

  function bomb(){
    s(boomS);
    setScene("p0.png","contain");          // 배경 유지하면서
    boomOverlay.style.opacity=1;           // 폭탄 오버레이만 올리기
    hint.textContent="뻥! 다시 해!";
    stopBubbles();
    setTimeout(()=>{ boomOverlay.style.opacity=0; resetToP0(); }, 900);
  }

  // ✅ “화면 터치하면 종이(pp0)” → “화면 터치하면 물약 부어진 종이(pp1)”
  // ✅ pp1에서 “다음버튼 생성” + “화면 터치하면 자물쇠”
  function showPaper0(){
    setScene("pp0.png","contain");
    hint.textContent="화면을 터치해 종이를 확인해라";
    fullTap(()=>{ s(paper); showPaper1(); });
  }

  function showPaper1(){
    setScene("pp1.png","contain");
    hint.textContent="0506…";
    const nextBtn = makeBottomNext("다음 ▶");
    nextBtn.onclick = ()=>{ s(tap); Lock2(); };
    fullTap(()=>{ s(tap); Lock2(); });
  }

  function Lock2(){
    lockStageWithTapToNext("0506","k1c.png","k1o.png",Books);
  }
}

/* ===== 3단계(여기부터는 너 기존대로 이어붙이면 됨) ===== */
function Books(){
  setScene("b0.png","cover");
  hint.textContent="세령공주에게 준 책을 찾아라";
  // 좌표는 b0 이미지에 맞춰 조절 필요
  addHS(10,60,30,10,()=>{ s(tap); hint.textContent="땡!"; setTimeout(()=>hint.textContent="세령공주에게 준 책을 찾아라",700); });
  addHS(10,72,30,10,()=>{ s(tap); hint.textContent="땡!"; setTimeout(()=>hint.textContent="세령공주에게 준 책을 찾아라",700); });
  addHS(10,84,30,10,()=>{
    s(get);
    setScene("key.png","cover");
    hint.textContent="열쇠 획득!";
    fullTap(()=>End());
  });
}

function End(){
  bgm.pause(); bgm.currentTime=0;
  endbgm.volume=0.5;
  endbgm.play().catch(()=>{});
  setScene("end.png","cover");
}

Start();
</script>
</body>
</html>
